<!-- <ion-header [translucent]="true" mode="ios">
  <ion-toolbar>
    <ion-title>Defina os Filtros</ion-title>
    <ion-buttons slot="start" (click)="limpaDados()">
      <ion-back-button  defaultHref="/home" text="Voltar"></ion-back-button>
    </ion-buttons>
    <ion-buttons slot="end">
      <ion-button routerLink="/home/precos" [disabled]="this.movimento.itemSelecionado.length === 0 || this.movimento.pessoasSelecionadas.length === 0">Avançar
        <ion-icon name="chevron-forward-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" mode="ios" style="text-align: center;" [ngClass]="{'conteudo': !auth.isMobile}">
  <ion-header [collapse]="auth.isMobile ? 'condense': '' ">
    <ion-toolbar>
      <ion-title size="large">Defina os Filtros
        <ion-badge [color]="this.dataLoad.dadosCarregados === false ? 'danger' : 'success'" style="margin-left: 10px;">
          <ion-icon name="cloud-done-outline" *ngIf="this.dataLoad.dadosCarregados === true"></ion-icon>
          <ion-icon name="cloud-offline-outline" *ngIf="this.dataLoad.dadosCarregados === false">Completo</ion-icon>
          <ion-label *ngIf="this.dataLoad.dadosCarregados === true" style="margin-left: 10px;">Completo</ion-label>
          <ion-label *ngIf="this.dataLoad.dadosCarregados === false" style="margin-left: 10px;">Processando</ion-label>
        </ion-badge>
      </ion-title>
    </ion-toolbar>
  </ion-header>
  <ion-list inset="true">
    <ion-segment value="C" (ionChange)="tipoFiltro($event)">
      <ion-segment-button value="C">
        <ion-label>Cliente</ion-label>
      </ion-segment-button>
      <ion-segment-button value="I">
        <ion-label>Item</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-list>
  <ion-list inset="true" style="margin-bottom: 0px;" *ngIf="filtro === 'C'">
    <ion-item color="light">
      <ion-select label="Região" placeholder="Selecione" [multiple]="true" (ionChange)="addRegiao($event)" [value]="this.movimento.regiaoSelecionada">
        <ion-select-option  *ngFor="let item of dataLoad.regiao" [value]="item">{{item.des_regiao_venda}}</ion-select-option>
      </ion-select>
    </ion-item>
  </ion-list>
  <ion-list inset="true" *ngIf="filtro === 'C'">
    <ion-searchbar color="" [debounce]="1000" (ionInput)="pesquisaCliente($event)" placeholder="Código, CNPJ ou Descrição"></ion-searchbar>
  </ion-list>
  <ion-list inset="true" *ngFor="let item of dataLoad.filtroPessoa" >
    <ion-item color="light" *ngIf="filtro === 'C'">
      <ion-label>
        <h3>{{item.nom_pessoa}}</h3>
        <p> Código {{item.cod_pessoa}} CNPJ {{item.num_cnpj_cpf}}</p>
        <p></p>
      </ion-label>
      <ion-icon *ngIf="item.ind_selecionado === false" slot="end" color="success" (click)="addPessoa(item)" name="add-outline"></ion-icon>
    </ion-item>
  </ion-list>
  <ion-list inset="true" *ngIf="filtro === 'I'">
    <ion-item color="light">
      <ion-select (ionChange)="marcarItens($event)" label="Marcar Itens" placeholder="Selecione" [multiple]="true">
        <ion-select-option  *ngFor="let item of itemfull" [value]="item.cod_item">{{item.cod_item}} - {{item.des_item}}</ion-select-option>
      </ion-select>
    </ion-item>
  </ion-list>
  <ng-container *ngFor="let empresaGroup of groupedItems" inset="true" >
    <ion-chip color="primary" *ngIf="filtro === 'I'">{{ empresaGroup.cod_empresa }} - {{empresaGroup.nom_fantasia}}</ion-chip>
    <ion-list inset="true" *ngIf="filtro === 'I'">
      <ion-item color="light" *ngFor="let item of empresaGroup.items">
        <ion-label>
          <h3>{{item.cod_item}} - {{item.des_item}}</h3>
        </ion-label>
      <ion-checkbox slot="end" [checked]="item.ind_selecionado" (ionChange)="addItem(item, $event)" [aria-label]="'Selecionar ' + item.nom_pessoa"></ion-checkbox>
      </ion-item>
    </ion-list>
  </ng-container>
</ion-content>
<ion-footer  mode="ios" [ngClass]="{'conteudo': !auth.isMobile}">
  <ion-list inset="true" *ngIf="this.movimento.pessoasSelecionadas.length > 0 && filtro === 'C'">
    <ion-button expand="block" color="success" (click)="setOpen(true)">Visualizar Clientes Adicionados</ion-button>
  </ion-list>
  <ion-modal [isOpen]="isModalOpenCliente" mode="ios">
    <ng-template>
      <ion-content class="ion-padding">
        <ion-header [collapse]="auth.isMobile ? 'condense': '' ">
          <ion-toolbar>
            <ion-title>Clientes Adicionados</ion-title>
            <ion-buttons slot="end" >
              <ion-button (click)="setOpen(false)">Close</ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <cdk-virtual-scroll-viewport itemSize="56" minBufferPx="900" maxBufferPx="1350">
          <ion-list inset="true" *cdkVirtualFor="let item of this.movimento.pessoasSelecionadas">
            <ion-item color="light" *ngIf="filtro === 'C'">
              <ion-label>
                <h3>{{item.nom_pessoa}}</h3>
                <p>CNPJ {{item.num_cnpj_cpf}}</p>
              </ion-label>
              <ion-icon slot="end" color="danger" (click)="removePessoa(item)" name="trash-outline"></ion-icon>
            </ion-item>
          </ion-list>
        </cdk-virtual-scroll-viewport>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-footer> -->

<ion-content
  [fullscreen]="true"
  mode="ios"
  [ngClass]="{'conteudo': !auth.isMobile}"
  class="filters-content"
>
  <div class="centered-page">
    <ion-toolbar>
      <ion-buttons slot="start">
        <ion-back-button
          defaultHref="/home"
          text="Voltar"
          (click)="limpaDados()"
        ></ion-back-button>
      </ion-buttons>

      <ion-buttons slot="end">
        <ion-button
          routerLink="/home/precos"
          [disabled]="this.movimento.itemSelecionado.length === 0 || this.movimento.pessoasSelecionadas.length === 0"
          class="next-button"
        >
          <span>Avançar</span>
          <ion-icon name="chevron-forward-outline" slot="end"></ion-icon>
        </ion-button>
      </ion-buttons>
    </ion-toolbar>
    <!-- Main Content -->
    <div class="responsive-container">
      <!-- Filter Type Selector -->
      <div class="filter-type-section">
        <div class="section-header">
          <ion-icon name="funnel-outline" class="section-icon"></ion-icon>
          <h2 class="section-title">Tipo de Filtro</h2>
          <ion-badge
            class="status-badge"
            [color]="dataLoad.dadosCarregados ? 'success' : 'danger'"
          >
            <ion-icon
              [name]="dataLoad.dadosCarregados ? 'cloud-done-outline' : 'cloud-offline-outline'"
            ></ion-icon>
            <ion-label
              >{{ dataLoad.dadosCarregados ? 'Dados Processados' : 'Processando'
              }}</ion-label
            >
          </ion-badge>
        </div>

        <div class="filter-type-cards">
          <div
            class="filter-type-card"
            [class.active]="filtro === 'C'"
            (click)="tipoFiltro({detail: {value: 'C'}})"
          >
            <div class="card-icon">
              <ion-icon name="people-circle-outline"></ion-icon>
            </div>
            <div class="card-content">
              <h3>Cliente</h3>
              <p>Selecione seus clientes</p>
              <ion-badge
                *ngIf="this.movimento.pessoasSelecionadas.length > 0"
                color="success"
                style="margin-top: 5px"
              >
                <ion-icon name="checkmark-circle-outline"></ion-icon>
                {{this.movimento.pessoasSelecionadas.length}} selecionados
              </ion-badge>
            </div>
            <div class="active-indicator" *ngIf="filtro === 'C'">
              <ion-icon name="checkmark-circle"></ion-icon>
            </div>
          </div>

          <div
            class="filter-type-card"
            [class.active]="filtro === 'I'"
            (click)="tipoFiltro({detail: {value: 'I'}})"
          >
            <div class="card-icon">
              <ion-icon name="cube-outline"></ion-icon>
            </div>
            <div class="card-content">
              <h3>Item</h3>
              <p>Selecione por produtos</p>
            </div>
            <div class="active-indicator" *ngIf="filtro === 'I'">
              <ion-icon name="checkmark-circle"></ion-icon>
            </div>
          </div>
        </div>
      </div>

      <!-- Region Filter (Clientes) -->
      <!-- <div class="filter-section" *ngIf="filtro === 'C'">
        <div class="section-header">
          <ion-icon name="location-outline" class="section-icon"></ion-icon>
          <h2 class="section-title">Filtrar por Região</h2>
        </div>

        <div class="region-selector">
          <ion-select label="Selecione as regiões" placeholder="Escolha as regiões" [multiple]="true"
            (ionChange)="addRegiao($event)" [value]="this.movimento.regiaoSelecionada" interface="action-sheet"
            class="custom-select">
            <ion-select-option *ngFor="let item of dataLoad.regiao" [value]="item">
              {{item.des_regiao_venda}}
            </ion-select-option>
          </ion-select>

          <div class="selected-regions" *ngIf="movimento.regiaoSelecionada?.length > 0">
            <div class="selected-tags">
              <ion-chip *ngFor="let regiao of movimento.regiaoSelecionada" color="primary" outline>
                <ion-label>{{regiao.des_regiao_venda}}</ion-label>
                <ion-icon name="close-circle" (click)="removeRegiao(regiao)"></ion-icon>
              </ion-chip>
            </div>
            <p class="selected-count">{{movimento.regiaoSelecionada.length}} região(ões) selecionada(s)</p>
          </div>
        </div>
      </div> -->

      <!-- Client Search -->
      <div class="filter-section" *ngIf="filtro === 'C'">
        <div class="section-header">
          <ion-icon name="search-outline" class="section-icon"></ion-icon>
          <h2 class="section-title">Buscar Clientes</h2>
        </div>

        <!-- Filtro de Data de Cadastro -->
        <div class="date-filter-modern">
          <div class="date-filter-header">
            <ion-icon
              name="calendar"
              color="primary"
              class="date-icon"
            ></ion-icon>
            <h3 class="date-filter-title">Pesquisar por Data de Cadastro</h3>
          </div>

          <div class="date-inputs-container">
            <div class="date-input-wrapper">
              <ion-label class="date-label">Data Inicial</ion-label>
              <ion-input
                type="date"
                [(ngModel)]="dataCadastroInicial"
                class="modern-date-input"
              ></ion-input>
            </div>

            <div class="date-separator">
              <ion-icon name="arrow-forward-outline"></ion-icon>
            </div>

            <div class="date-input-wrapper">
              <ion-label class="date-label">Data Final</ion-label>
              <ion-input
                type="date"
                [(ngModel)]="dataCadastroFinal"
                class="modern-date-input"
              ></ion-input>
            </div>
          </div>

          <div class="date-actions">
            <ion-button
              *ngIf="dataCadastroInicial || dataCadastroFinal"
              expand="block"
              fill="solid"
              color="primary"
              size="default"
              (click)="aplicarFiltroData()"
              class="apply-date-button"
            >
              <ion-icon name="filter-outline" slot="start"></ion-icon>
              Aplicar Filtro
            </ion-button>

            <ion-button
              *ngIf="dataCadastroInicial || dataCadastroFinal"
              expand="block"
              fill="clear"
              color="danger"
              size="small"
              (click)="limparFiltroData()"
              class="clear-date-button"
            >
              <ion-icon name="close-circle-outline" slot="start"></ion-icon>
              Limpar datas
            </ion-button>
          </div>
        </div>

        <div class="search-container">
          <ion-searchbar
            [debounce]="1000"
            (ionInput)="pesquisaCliente($event)"
            placeholder="Digite código, CNPJ ou nome do cliente ( + de 3 digitos )"
            animated="true"
            class="custom-searchbar"
          >
          </ion-searchbar>
        </div>
      </div>

      <!-- Client List -->
      <div
        class="results-section"
        *ngIf="filtro === 'C' && dataLoad.filtroPessoa?.length > 0"
      >
        <div class="section-header">
          <ion-icon name="list-outline" class="section-icon"></ion-icon>
          <h2 class="section-title">Clientes Encontrados</h2>
          <ion-badge class="results-count" color="primary">
            {{resultadosVisiveis.length}}{{todosResultados.length >
            TAMANHO_PAGINA ? ' de ' + todosResultados.length : ''}}
          </ion-badge>
        </div>

        <div class="client-list">
          <div
            *ngFor="let item of resultadosVisiveis; trackBy: trackByPessoa"
            class="client-card"
            [class.selected]="item.ind_selecionado"
          >
            <div class="client-info">
              <div class="client-avatar">
                <div class="avatar-content">{{item.nom_pessoa.charAt(0)}}</div>
              </div>

              <div class="client-details">
                <h3 class="client-name">{{item.nom_pessoa}}</h3>
                <div class="client-metadata">
                  <span class="client-id">
                    <ion-icon name="key-outline"></ion-icon>
                    {{item.cod_pessoa}}
                  </span>
                  <span class="client-cnpj">
                    <ion-icon name="document-text-outline"></ion-icon>
                    {{item.num_cnpj_cpf}}
                  </span>
                </div>
              </div>
            </div>

            <ion-button
              *ngIf="!item.ind_selecionado"
              fill="clear"
              color="success"
              (click)="addPessoa(item)"
              class="add-button"
            >
              <ion-icon name="add-circle-outline"></ion-icon>
              Adicionar
            </ion-button>

            <ion-button
              *ngIf="item.ind_selecionado"
              fill="clear"
              color="danger"
              (click)="removePessoa(item)"
              class="remove-button"
            >
              <ion-icon name="close-circle-outline"></ion-icon>
              Remover
            </ion-button>
          </div>

          <!-- Infinite Scroll -->
          <ion-infinite-scroll
            *ngIf="temMaisResultados"
            threshold="100px"
            (ionInfinite)="onInfiniteScroll($event)"
          >
            <ion-infinite-scroll-content
              loadingSpinner="crescent"
              loadingText="⏳ Carregando mais clientes..."
            >
            </ion-infinite-scroll-content>
          </ion-infinite-scroll>
        </div>
      </div>

      <!-- Item Selection -->
      <div class="filter-section" *ngIf="filtro === 'I'">
        <div class="section-header">
          <ion-icon name="cube-outline" class="section-icon"></ion-icon>
          <h2 class="section-title">Seleção de Itens</h2>
        </div>

        <div class="bulk-selector-modern">
          <div class="selector-header">
            <div class="header-icon">
              <ion-icon name="layers-outline"></ion-icon>
            </div>
            <div class="header-text">
              <h3>Seleção em Massa</h3>
              <p>Adicione múltiplos itens de uma vez</p>
            </div>
          </div>

          <ion-button
            expand="block"
            (click)="abrirModalSelecaoMassa()"
            class="modern-select-button"
          >
            <ion-icon name="list-outline" slot="start"></ion-icon>
            Selecionar Itens
            <ion-icon name="chevron-forward" slot="end"></ion-icon>
          </ion-button>
        </div>
      </div>

      <!-- Items by Company -->
      <div class="results-section" *ngIf="filtro === 'I'">
        <div *ngFor="let empresaGroup of groupedItems" class="company-section">
          <div class="company-header">
            <div class="company-info">
              <div class="company-avatar">
                <div class="avatar-content">{{empresaGroup.cod_empresa}}</div>
              </div>
              <div>
                <h3 class="company-name">{{empresaGroup.nom_fantasia}}</h3>
                <p class="company-code">Código: {{empresaGroup.cod_empresa}}</p>
              </div>
            </div>
            <ion-badge color="medium">
              {{empresaGroup.items.length}} itens
            </ion-badge>
          </div>

          <div class="items-grid">
            <div
              *ngFor="let item of empresaGroup.items"
              class="item-card"
              [class.selected]="item.ind_selecionado"
            >
              <div class="item-info">
                <h4 class="item-code">{{item.cod_item}}</h4>
                <p class="item-description">{{item.des_item}}</p>
              </div>

              <ion-checkbox
                [checked]="item.ind_selecionado"
                (ionChange)="addItem(item, $event)"
                class="item-checkbox"
                [aria-label]="'Selecionar item ' + item.des_item"
              >
              </ion-checkbox>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Selected Clients Modal -->
    <ion-modal
      [isOpen]="isModalOpenCliente"
      mode="ios"
      class="selected-clients-modal-compact"
    >
      <ng-template>
        <ion-header class="ion-no-border">
          <ion-toolbar>
            <ion-title>Clientes Selecionados</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="setOpen(false)" fill="clear">
                <ion-icon name="close-outline"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>

        <ion-content class="ion-padding">
          <div class="selected-summary">
            <div class="summary-card">
              <ion-icon name="people-circle" color="primary"></ion-icon>
              <div>
                <h3>{{this.movimento.pessoasSelecionadas.length}} Clientes</h3>
                <p>Adicionados para negociação</p>
                <p style="color: lightcoral">
                  Deslize o registro para a direta para remover
                </p>
              </div>
            </div>
          </div>

          <div
            class="selected-clients-list"
            *ngIf="this.movimento.pessoasSelecionadas.length > 0"
          >
            <ion-list lines="none" class="form-list">
              <ion-item-sliding
                *ngFor="let item of this.movimento.pessoasSelecionadas; let i = index"
              >
                <ion-item class="selected-client-item">
                  <ion-avatar slot="start">
                    <div class="selected-avatar">
                      {{item.nom_pessoa.charAt(0)}}
                    </div>
                  </ion-avatar>

                  <ion-label>
                    <h3>{{item.nom_pessoa}}</h3>
                    <p>CNPJ: {{item.num_cnpj_cpf}}</p>
                    <ion-badge color="light" mode="ios">
                      Código: {{item.cod_pessoa}}
                    </ion-badge>
                  </ion-label>
                </ion-item>

                <ion-item-options side="end">
                  <ion-item-option color="danger" (click)="removePessoa(item)">
                    <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                  </ion-item-option>
                </ion-item-options>
              </ion-item-sliding>
            </ion-list>
          </div>

          <div
            *ngIf="this.movimento.pessoasSelecionadas.length === 0"
            class="empty-state"
          >
            <ion-icon name="people-outline"></ion-icon>
            <h3>Nenhum cliente selecionado</h3>
            <p>Adicione clientes para continuar</p>
          </div>
        </ion-content>

        <ion-footer class="modal-footer">
          <ion-grid>
            <ion-row>
              <ion-col>
                <ion-button
                  expand="block"
                  (click)="setOpen(false)"
                  fill="outline"
                >
                  Fechar
                </ion-button>
              </ion-col>
              <ion-col>
                <ion-button
                  expand="block"
                  color="primary"
                  (click)="setOpen(false)"
                >
                  Continuar
                </ion-button>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-footer>
      </ng-template>
    </ion-modal>

    <!-- Floating Action Button for Selected Clients -->
    <ion-fab
      *ngIf="this.movimento.pessoasSelecionadas.length > 0 && filtro === 'C'"
      vertical="bottom"
      horizontal="end"
      slot="fixed"
    >
      <ion-fab-button color="primary" (click)="setOpen(true)">
        <ion-icon name="people"></ion-icon>
        <ion-badge class="fab-badge" color="danger"
          >{{this.movimento.pessoasSelecionadas.length}}</ion-badge
        >
      </ion-fab-button>
    </ion-fab>

    <!-- Modal Seleção em Massa -->
    <ion-modal
      [isOpen]="isModalSelecaoMassaOpen"
      mode="ios"
      class="selecao-massa-modal"
      (didDismiss)="fecharModalSelecaoMassa()"
    >
      <ng-template>
        <ion-header class="ion-no-border">
          <ion-toolbar>
            <ion-title>Seleção em Massa</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="fecharModalSelecaoMassa()" fill="clear">
                <ion-icon name="close-outline"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
          <ion-toolbar>
            <ion-searchbar
              [debounce]="300"
              (ionInput)="filtrarItensModal($event)"
              placeholder="Buscar item..."
              animated="true"
            >
            </ion-searchbar>
          </ion-toolbar>
        </ion-header>

        <ion-content class="ion-padding">
          <div class="items-selection-list" *ngIf="itensFiltradosModal.length > 0">
            <div
              *ngFor="let item of itensFiltradosModal"
              class="item-selection-card"
              (click)="toggleItemModal(item)"
              [class.selected]="isItemSelecionadoModal(item)"
            >
              <div class="item-checkbox">
                <ion-checkbox
                  [checked]="isItemSelecionadoModal(item)"
                  (click)="toggleItemModal(item); $event.stopPropagation()"
                ></ion-checkbox>
              </div>
              <div class="item-info-modal">
                <h3>{{item.des_item}}</h3>
                <p>Código: {{item.cod_item}}</p>
              </div>
              <div class="selected-badge" *ngIf="isItemSelecionadoModal(item)">
                <ion-icon name="checkmark-circle"></ion-icon>
              </div>
            </div>
          </div>

          <div class="empty-state" *ngIf="itensFiltradosModal.length === 0">
            <ion-icon name="search-outline"></ion-icon>
            <h3>Nenhum item encontrado</h3>
            <p>Tente buscar por outro termo</p>
          </div>
        </ion-content>

        <ion-footer class="modal-footer">
          <ion-grid>
            <ion-row>
              <ion-col>
                <ion-button
                  expand="block"
                  fill="outline"
                  (click)="fecharModalSelecaoMassa()"
                >
                  Cancelar
                </ion-button>
              </ion-col>
              <ion-col>
                <ion-button
                  expand="block"
                  color="primary"
                  (click)="confirmarSelecaoMassa()"
                >
                  Confirmar ({{itensSelecionadosModal.length}})
                </ion-button>
              </ion-col>
            </ion-row>
          </ion-grid>
        </ion-footer>
      </ng-template>
    </ion-modal>
  </div>
</ion-content>
